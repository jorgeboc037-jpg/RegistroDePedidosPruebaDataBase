<!doctype html>
<html lang="es">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Pedidos - Importadora Kairos</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100%;
            width: 100%;
        }

        * {
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            min-height: 100%;
            padding: 2rem 1rem;
            overflow-y: auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 2rem;
        }

        .header h1 {
            margin: 0 0 0.5rem 0;
            font-size: 2rem;
            font-weight: 700;
        }

        .header p {
            margin: 0;
            opacity: 0.9;
            font-size: 1rem;
        }

        .nav-tabs {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .tab-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 0.75rem 2rem;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .tab-btn.active {
            background: white;
            color: #667eea;
            border-color: white;
        }

        .content-card {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-section {
            margin-bottom: 2rem;
        }

        .form-section h2 {
            color: #667eea;
            font-size: 1.5rem;
            margin: 0 0 1rem 0;
            font-weight: 600;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 500;
            color: #333;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select {
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group input:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
        }

        .products-section {
            margin-top: 2rem;
        }

        .products-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            overflow-x: auto;
            display: block;
        }

        .products-table table {
            width: 100%;
            min-width: 600px;
        }

        .products-table th {
            background: #667eea;
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .products-table th:first-child {
            border-radius: 10px 0 0 0;
        }

        .products-table th:last-child {
            border-radius: 0 10px 0 0;
        }

        .products-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e0e0e0;
        }

        .products-table input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .products-table input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-success:hover {
            background: #38a169;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(72, 187, 120, 0.4);
        }

        .btn-danger {
            background: #f56565;
            color: white;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .btn-secondary {
            background: #718096;
            color: white;
        }

        .btn-secondary:hover {
            background: #4a5568;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .totals-section {
            background: #f7fafc;
            padding: 1.5rem;
            border-radius: 10px;
            margin-top: 1.5rem;
        }

        .totals-section h3 {
            color: #667eea;
            margin: 0 0 1rem 0;
            font-size: 1.25rem;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            font-size: 1rem;
        }

        .total-row.final {
            border-top: 2px solid #667eea;
            margin-top: 0.5rem;
            padding-top: 1rem;
            font-size: 1.25rem;
            font-weight: 700;
            color: #667eea;
        }

        .history-table {
            width: 100%;
            overflow-x: auto;
        }

        .history-table table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        .history-table th {
            background: #667eea;
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
        }

        .history-table td {
            padding: 1rem;
            border-bottom: 1px solid #e0e0e0;
        }

        .history-table tr:hover {
            background: #f7fafc;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #667eea;
            font-size: 1.1rem;
        }

        .message {
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .message-success {
            background: #c6f6d5;
            color: #22543d;
            border: 2px solid #48bb78;
        }

        .message-error {
            background: #fed7d7;
            color: #742a2a;
            border: 2px solid #f56565;
        }

        @media (max-width: 768px) {
            .content-card {
                padding: 1.5rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div id="login">
  <h2>Iniciar sesi贸n</h2>
  <input id="loginEmail" placeholder="Email">
  <input id="loginPassword" type="password" placeholder="Contrase帽a">
  <button onclick="login()">Entrar</button>
</div>

<div id="app" style="display:none">
  <div class="container">
   <div class="header">
    <h1> Importadora Kairos</h1>
    <p>Sistema de Gesti贸n de Pedidos</p>
   </div>
   <div class="nav-tabs"><button class="tab-btn active" onclick="switchTab('create')">Crear Pedido</button> <button class="tab-btn" onclick="switchTab('history')">Historial de Pedidos</button>
   </div>
   <div class="content-card">
    <div id="create-tab" class="tab-content active">
     <div id="message-container"></div>
     <div class="form-section">
      <h2> Informaci贸n del Pedido</h2>
      <div class="form-grid">
       <div class="form-group"><label for="order-id">Identificador del Pedido</label> <input type="text" id="order-id" placeholder="Ej: PED" value="PED">
       </div>
       <div class="form-group"><label for="order-date">Fecha</label> <input type="text" id="order-date" disabled>
       </div>
      </div>
     </div>
     <div class="form-section">
      <h2> Informaci贸n del Cliente</h2>
      <div class="form-grid">
       <div class="form-group"><label for="customer-name">Nombre del Cliente</label> <input type="text" id="customer-name" placeholder="Ingrese el nombre">
       </div>
       <div class="form-group"><label for="customer-phone">Tel茅fono</label> <input type="tel" id="customer-phone" placeholder="Ej: 3649-8391">
       </div>
       <div class="form-group"><label for="business-name">Nombre del Negocio</label> <input type="text" id="business-name" placeholder="Ingrese el nombre del negocio">
       </div>
       <div class="form-group"><label for="customer-address">Direcci贸n</label> <input type="text" id="customer-address" placeholder="Ingrese la direcci贸n">
       </div>
       <div class="form-group"><label for="customer-nit">NIT</label> <input type="text" id="customer-nit" placeholder="Ingrese el NIT">
       </div>
      </div>
     </div>
     <div class="products-section">
      <h2> Productos</h2>
      <div class="products-table">
       <table id="products-table">
        <thead>
         <tr>
          <th>C贸digo</th>
          <th>Nombre del Producto</th>
          <th>Cantidad</th>
          <th>Precio Unitario (Q)</th>
          <th>Total (Q)</th>
          <th>Acciones</th>
         </tr>
        </thead>
        <tbody id="products-body">
        </tbody>
       </table>
      </div><button class="btn btn-secondary" onclick="addProductRow()">+ Agregar Producto</button>
      <div class="totals-section">
       <h3> Resumen del Pedido</h3>
       <div class="total-row"><span>Subtotal:</span> <span id="subtotal-display">Q 0.00</span>
       </div>
       <div class="total-row final"><span>TOTAL:</span> <span id="total-display">Q 0.00</span>
       </div>
      </div>
     </div>
     <div class="action-buttons"><button class="btn btn-success" onclick="saveAndGeneratePDF()"> Guardar y Generar PDF</button> <button class="btn btn-primary" onclick="clearForm()"> Limpiar Formulario</button>
     </div>
    </div>
    <div id="history-tab" class="tab-content">
     <h2> Historial de Pedidos</h2>
     <div id="history-loading" class="loading">
      Cargando pedidos...
     </div>
     <div id="history-content" style="display: none;">
      <div class="history-table">
       <table>
        <thead>
         <tr>
          <th>N掳 Pedido</th>
          <th>Fecha</th>
          <th>Cliente</th>
          <th>Negocio</th>
          <th>Total</th>
          <th>Acciones</th>
         </tr>
        </thead>
        <tbody id="history-body">
        </tbody>
       </table>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
        const SUPABASE_URL = 'https://ryaawzodxtvcfvxphkgf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ5YWF3em9keHR2Y2Z2eHBoa2dmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NzkyNTUsImV4cCI6MjA4NTM1NTI1NX0.bP3opRjM4639oAa3X0xoGh5i86r1mtRmq_wQ2s_dv0w';

        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
   
   async function checkSession() {
    const { data: { session } } = await supabase.auth.getSession();

    if (!session) {
      document.getElementById("login").style.display = "block";
      document.getElementById("app").style.display = "none";
    } else {
      document.getElementById("login").style.display = "none";
      document.getElementById("app").style.display = "block";
    }
  }

  checkSession();
   async function logout() {
  await supabase.auth.signOut();
  location.reload();
}


        const COMPANY_NAME = 'Importadora Kairos';
        const COMPANY_ADDRESS = 'Local 54, Plaza Atanasio Tzul, Zona 12';
        const COMPANY_PHONE = '3649-8391';

        let productCounter = 0;

        function initializeApp() {
            setCurrentDate();
            addProductRow();
            addProductRow();
            addProductRow();
        }

        function setCurrentDate() {
            const today = new Date();
            const dateStr = formatDate(today);
            document.getElementById('order-date').value = dateStr;
        }

        function formatDate(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return day + '/' + month + '/' + year;
        }

        function switchTab(tabName) {
            const tabs = document.querySelectorAll('.tab-content');
            const buttons = document.querySelectorAll('.tab-btn');

            tabs.forEach(function(tab) {
                tab.classList.remove('active');
            });

            buttons.forEach(function(btn) {
                btn.classList.remove('active');
            });

            if (tabName === 'create') {
                document.getElementById('create-tab').classList.add('active');
                buttons[0].classList.add('active');
            } else if (tabName === 'history') {
                document.getElementById('history-tab').classList.add('active');
                buttons[1].classList.add('active');
                loadHistory();
            }
        }

        function addProductRow() {
            productCounter++;
            const tbody = document.getElementById('products-body');
            const row = document.createElement('tr');
            row.id = 'product-row-' + productCounter;

            row.innerHTML = '<td><input type="text" class="product-code" placeholder="C贸digo"></td>' +
                '<td><input type="text" class="product-name" placeholder="Nombre del producto"></td>' +
                '<td><input type="number" class="product-quantity" placeholder="0" min="0" oninput="calculateRowTotal(' + productCounter + ')"></td>' +
                '<td><input type="number" class="product-price" placeholder="0.00" min="0" step="0.01" oninput="calculateRowTotal(' + productCounter + ')"></td>' +
                '<td><input type="text" class="product-total" placeholder="Q 0.00" disabled></td>' +
                '<td><button class="btn btn-danger" onclick="removeProductRow(' + productCounter + ')">Eliminar</button></td>';

            tbody.appendChild(row);
        }

        function removeProductRow(rowId) {
            const row = document.getElementById('product-row-' + rowId);
            if (row) {
                row.remove();
                calculateTotals();
            }
        }

        function calculateRowTotal(rowId) {
            const row = document.getElementById('product-row-' + rowId);
            if (!row) return;

            const quantity = parseFloat(row.querySelector('.product-quantity').value) || 0;
            const price = parseFloat(row.querySelector('.product-price').value) || 0;
            const total = quantity * price;

            row.querySelector('.product-total').value = 'Q ' + total.toFixed(2);
            calculateTotals();
        }

        function calculateTotals() {
            const rows = document.querySelectorAll('#products-body tr');
            let subtotal = 0;

            rows.forEach(function(row) {
                const quantity = parseFloat(row.querySelector('.product-quantity').value) || 0;
                const price = parseFloat(row.querySelector('.product-price').value) || 0;
                subtotal += quantity * price;
            });

            const total = subtotal;

            document.getElementById('subtotal-display').textContent = 'Q ' + subtotal.toFixed(2);
            document.getElementById('total-display').textContent = 'Q ' + total.toFixed(2);
        }

        function getProductsData() {
            const rows = document.querySelectorAll('#products-body tr');
            const products = [];
            const codigos = [];

            rows.forEach(function(row) {
                const code = row.querySelector('.product-code').value.trim();
                const name = row.querySelector('.product-name').value.trim();
                const quantity = parseFloat(row.querySelector('.product-quantity').value) || 0;
                const price = parseFloat(row.querySelector('.product-price').value) || 0;

                if (name && quantity > 0 && price > 0) {
                    products.push({
                        codigo: code,
                        nombre: name,
                        cantidad: quantity,
                        precio_unitario: price,
                        total: quantity * price
                    });
                    if (code) {
                        codigos.push(code);
                    }
                }
            });

            return { products: products, codigos: codigos };
        }

        function validateForm() {
            const customerName = document.getElementById('customer-name').value.trim();
            const businessName = document.getElementById('business-name').value.trim();
            const productsData = getProductsData();

            if (!customerName) {
                showMessage('Por favor ingrese el nombre del cliente', 'error');
                return false;
            }

            if (!businessName) {
                showMessage('Por favor ingrese el nombre del negocio', 'error');
                return false;
            }

            if (productsData.products.length === 0) {
                showMessage('Por favor agregue al menos un producto con cantidad y precio', 'error');
                return false;
            }

            return true;
        }

        function showMessage(text, type) {
            const container = document.getElementById('message-container');
            const messageClass = type === 'success' ? 'message-success' : 'message-error';
            container.innerHTML = '<div class="message ' + messageClass + '">' + text + '</div>';

            setTimeout(function() {
                container.innerHTML = '';
            }, 5000);
        }

        async function getDailyConsecutive() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const datePrefix = year + month + day;

            try {
                const { data, error } = await supabaseClient
                    .from('Pedidos')
                    .select('order_number')
                    .like('order_number', '%' + datePrefix + '%')
                    .order('order_number', { ascending: false })
                    .limit(1);

                if (error) throw error;

                if (data && data.length > 0) {
                    const lastOrderNumber = data[0].order_number;
                    const parts = lastOrderNumber.split('-');
                    if (parts.length >= 2) {
                        const lastConsecutive = parseInt(parts[parts.length - 1]) || 0;
                        return lastConsecutive + 1;
                    }
                }

                return 1;
            } catch (error) {
                console.error('Error obteniendo consecutivo:', error);
                return 1;
            }
        }

        function generateOrderNumber(manualId, consecutive) {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const dateStr = year + month + day;
            const consecutiveStr = String(consecutive).padStart(4, '0');

            return manualId + '-' + dateStr + '-' + consecutiveStr;
        }

        async function saveAndGeneratePDF() {
            if (!validateForm()) return;

            showMessage('Procesando pedido...', 'success');

            try {
                const manualId = document.getElementById('order-id').value.trim() || 'PED';
                const consecutive = await getDailyConsecutive();
                const orderNumber = generateOrderNumber(manualId, consecutive);

                const customerName = document.getElementById('customer-name').value.trim();
                const customerPhone = document.getElementById('customer-phone').value.trim();
                const businessName = document.getElementById('business-name').value.trim();
                const customerAddress = document.getElementById('customer-address').value.trim();
                const customerNit = document.getElementById('customer-nit').value.trim();

                const productsData = getProductsData();
                const subtotalValue = parseFloat(document.getElementById('subtotal-display').textContent.replace('Q ', ''));
                const totalValue = parseFloat(document.getElementById('total-display').textContent.replace('Q ', ''));

                const orderData = {
                    order_number: orderNumber,
                    customer_name: customerName,
                    business_name: businessName,
                    customer_nit: customerNit,
                    customer_address: customerAddress,
                    currency: 'Quetzales',
                    items: productsData.products,
                    subtotal: subtotalValue,
                    total: totalValue,
                    codigo_products: productsData.codigos.join(', ')
                };

                const { data, error } = await supabaseClient
                    .from('Pedidos')
                    .insert([orderData])
                    .select();

                if (error) throw error;

                showMessage('隆Pedido guardado exitosamente!', 'success');

                await generatePDF(orderNumber, customerName, customerPhone, businessName, customerAddress, customerNit, productsData.products, subtotalValue, totalValue);

                setTimeout(function() {
                    clearForm();
                }, 2000);

            } catch (error) {
                console.error('Error guardando pedido:', error);
                showMessage('Error al guardar el pedido: ' + error.message, 'error');
            }
        }

        async function generatePDF(orderNumber, customerName, customerPhone, businessName, customerAddress, customerNit, products, subtotal, total) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text(COMPANY_NAME, 105, 20, { align: 'center' });

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(COMPANY_ADDRESS, 105, 27, { align: 'center' });
            doc.text('Tel: ' + COMPANY_PHONE, 105, 32, { align: 'center' });

            doc.setLineWidth(0.5);
            doc.line(20, 37, 190, 37);

            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('PEDIDO N掳: ' + orderNumber, 20, 45);

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            const today = new Date();
            doc.text('Fecha: ' + formatDate(today), 20, 52);

            doc.setFont(undefined, 'bold');
            doc.text('INFORMACIN DEL CLIENTE', 20, 62);
            doc.setFont(undefined, 'normal');
            doc.text('Nombre: ' + customerName, 20, 69);
            doc.text('Tel茅fono: ' + customerPhone, 20, 76);
            doc.text('Negocio: ' + businessName, 20, 83);
            doc.text('Direcci贸n: ' + customerAddress, 20, 90);
            doc.text('NIT: ' + customerNit, 20, 97);

            doc.setFont(undefined, 'bold');
            doc.text('DETALLE DE PRODUCTOS', 20, 110);

            let yPos = 120;
            doc.setFillColor(102, 126, 234);
            doc.rect(20, yPos - 7, 170, 8, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.text('C贸digo', 22, yPos - 2);
            doc.text('Producto', 50, yPos - 2);
            doc.text('Cant.', 120, yPos - 2);
            doc.text('Precio Unit.', 140, yPos - 2);
            doc.text('Total', 170, yPos - 2);

            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            yPos += 8;

            products.forEach(function(product) {
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 20;
                }

                doc.text(product.codigo || '', 22, yPos);
                const productName = product.nombre.length > 35 ? product.nombre.substring(0, 35) + '...' : product.nombre;
                doc.text(productName, 50, yPos);
                doc.text(String(product.cantidad), 120, yPos);
                doc.text('Q ' + product.precio_unitario.toFixed(2), 140, yPos);
                doc.text('Q ' + product.total.toFixed(2), 170, yPos);

                yPos += 7;
            });

            yPos += 5;
            doc.setLineWidth(0.3);
            doc.line(20, yPos, 190, yPos);

            yPos += 8;
            doc.setFont(undefined, 'bold');
            doc.text('Subtotal:', 140, yPos);
            doc.text('Q ' + subtotal.toFixed(2), 170, yPos);

            yPos += 8;
            doc.setFontSize(11);
            doc.text('TOTAL:', 140, yPos);
            doc.text('Q ' + total.toFixed(2), 170, yPos);

            const fileName = businessName.replace(/[^a-z0-9]/gi, '_') + '_' + orderNumber + '.pdf';
            doc.save(fileName);
        }

        function clearForm() {
            document.getElementById('order-id').value = 'PED';
            document.getElementById('customer-name').value = '';
            document.getElementById('customer-phone').value = '';
            document.getElementById('business-name').value = '';
            document.getElementById('customer-address').value = '';
            document.getElementById('customer-nit').value = '';

            document.getElementById('products-body').innerHTML = '';
            productCounter = 0;
            addProductRow();
            addProductRow();
            addProductRow();

            calculateTotals();
            setCurrentDate();
            showMessage('Formulario limpiado correctamente', 'success');
        }

        async function loadHistory() {
            const loadingDiv = document.getElementById('history-loading');
            const contentDiv = document.getElementById('history-content');
            const tbody = document.getElementById('history-body');

            loadingDiv.style.display = 'block';
            contentDiv.style.display = 'none';

            try {
                const { data, error } = await supabaseClient
                    .from('Pedidos')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                tbody.innerHTML = '';

                if (data && data.length > 0) {
                    data.forEach(function(order) {
                        const row = document.createElement('tr');
                        
                        const createdDate = order.created_at ? new Date(order.created_at) : new Date();
                        const dateStr = formatDate(createdDate);

                        row.innerHTML = '<td>' + order.order_number + '</td>' +
                            '<td>' + dateStr + '</td>' +
                            '<td>' + order.customer_name + '</td>' +
                            '<td>' + order.business_name + '</td>' +
                            '<td>Q ' + parseFloat(order.total).toFixed(2) + '</td>' +
                            '<td><button class="btn btn-primary" onclick="viewOrderDetails(\'' + order.order_number + '\')">Ver Detalles</button></td>';

                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">No hay pedidos registrados</td></tr>';
                }

                loadingDiv.style.display = 'none';
                contentDiv.style.display = 'block';

            } catch (error) {
                console.error('Error cargando historial:', error);
                loadingDiv.innerHTML = '<div style="color: #f56565;">Error al cargar el historial: ' + error.message + '</div>';
            }
        }

        async function viewOrderDetails(orderNumber) {
            try {
                const { data, error } = await supabaseClient
                    .from('Pedidos')
                    .select('*')
                    .eq('order_number', orderNumber)
                    .single();

                if (error) throw error;

                if (data) {
                    await regeneratePDF(data);
                }

            } catch (error) {
                console.error('Error obteniendo detalles:', error);
                alert('Error al obtener los detalles del pedido');
            }
        }

        async function regeneratePDF(orderData) {
            const products = orderData.items || [];
            
            await generatePDF(
                orderData.order_number,
                orderData.customer_name,
                '',
                orderData.business_name,
                orderData.customer_address || '',
                orderData.customer_nit || '',
                products,
                parseFloat(orderData.subtotal),
                parseFloat(orderData.total)
            );
        }

        window.onload = initializeApp;
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c7b6e8295d0b0bf',t:'MTc3MDA1MzU4Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>

</html>
